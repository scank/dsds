# 系统架构图

## 1. 整体系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        STM32F407 主控系统                        │
├─────────────────────────────────────────────────────────────────┤
│  应用层 (Application Layer)                                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │  重量测量   │ │  信号处理   │ │  通信协议   │ │  状态管理   │ │
│  │  模块       │ │  模块       │ │  模块       │ │  模块       │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  中间件层 (Middleware Layer)                                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │  卡尔曼滤波 │ │  IIR滤波    │ │  均值滤波   │ │  Modbus协议 │ │
│  │  算法       │ │  算法       │ │  算法       │ │  栈         │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  驱动层 (Driver Layer)                                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │  KY5530     │ │  UART驱动   │ │  GPIO驱动   │ │  定时器驱动 │ │
│  │  ADC驱动    │ │  (RS485)    │ │             │ │             │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  HAL层 (Hardware Abstraction Layer)                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │  SPI HAL    │ │  UART HAL    │ │  GPIO HAL   │ │  TIM HAL    │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 数据流架构

```
重量传感器 → KY5530 ADC → SPI接口 → STM32F407
    ↓
原始ADC数据 → 卡尔曼滤波 → IIR滤波 → 均值滤波
    ↓
处理后的重量数据 → Modbus寄存器 → RS485接口 → PLC
    ↓
状态信息 → 动态/稳态检测 → 超量程检测 → 去皮/标定
```

## 3. 中断优先级架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        中断优先级分配                           │
├─────────────────────────────────────────────────────────────────┤
│  优先级 0 (最高): TIM14 - 状态检测 (10Hz)                      │
│  优先级 1:        TIM10 - 数据采集 (1500Hz)                    │
│  优先级 2:        TIM11 - 均值计算 (100Hz)                      │
│  优先级 2:        TIM7  - 调试输出 (3Hz)                       │
│  优先级 3 (最低): TIM13 - Modbus超时 (10kHz)                   │
└─────────────────────────────────────────────────────────────────┘
```

## 4. 内存映射架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        STM32F407 内存映射                       │
├─────────────────────────────────────────────────────────────────┤
│  0x20000000 - 0x2001FFFF: SRAM (128KB)                        │
│  ├─ 0x20000000 - 0x20001000: 全局变量区                        │
│  ├─ 0x20001000 - 0x20002000: 栈空间                           │
│  └─ 0x20002000 - 0x2001FFFF: 堆空间                           │
├─────────────────────────────────────────────────────────────────┤
│  0x08000000 - 0x0807FFFF: Flash (512KB)                       │
│  ├─ 0x08000000 - 0x08004000: 启动代码                         │
│  ├─ 0x08004000 - 0x08020000: 应用程序                         │
│  └─ 0x08020000 - 0x0807FFFF: 用户数据                         │
└─────────────────────────────────────────────────────────────────┘
```

## 5. 通信协议架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        Modbus RTU 协议栈                        │
├─────────────────────────────────────────────────────────────────┤
│  应用层: 重量数据、状态信息、控制命令                           │
├─────────────────────────────────────────────────────────────────┤
│  表示层: 数据格式转换、单位转换                                 │
├─────────────────────────────────────────────────────────────────┤
│  会话层: 请求/响应管理、超时处理                                │
├─────────────────────────────────────────────────────────────────┤
│  传输层: CRC校验、帧格式处理                                    │
├─────────────────────────────────────────────────────────────────┤
│  网络层: 地址识别、功能码处理                                   │
├─────────────────────────────────────────────────────────────────┤
│  数据链路层: RS485物理层                                        │
└─────────────────────────────────────────────────────────────────┘
```

## 6. 信号处理架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        信号处理流水线                           │
├─────────────────────────────────────────────────────────────────┤
│  输入: 24位ADC原始数据                                          │
│    ↓                                                           │
│  预处理: 数据有效性检查、超时检测                               │
│    ↓                                                           │
│  卡尔曼滤波: 动态噪声抑制、状态估计                             │
│    ↓                                                           │
│  IIR滤波: 频域滤波、进一步降噪                                 │
│    ↓                                                           │
│  均值滤波: 滑动窗口平均、平滑处理                               │
│    ↓                                                           │
│  后处理: 单位转换、范围检查                                     │
│    ↓                                                           │
│  输出: 最终重量值                                               │
└─────────────────────────────────────────────────────────────────┘
```

## 7. 任务调度架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        任务调度时序图                           │
├─────────────────────────────────────────────────────────────────┤
│  时间轴: 0ms    1ms    2ms    3ms    4ms    5ms    6ms    7ms   │
│         │      │      │      │      │      │      │      │     │
│  TIM10: │││││││││ │
│  (1.5kHz)                                                      │
│         │      │      │      │      │      │      │      │     │
│  TIM11: │      │      │      │      │      │      │      │     │
│  (100Hz)│      │      │      │      │      │      │      │     │
│         │      │      │      │      │      │      │      │     │
│  TIM7:  │      │      │      │      │      │      │      │     │
│  (3Hz)  │      │      │      │      │      │      │      │     │
│         │      │      │      │      │      │      │      │     │
│  TIM14: │      │      │      │      │      │      │      │     │
│  (10Hz) │      │      │      │      │      │      │      │     │
└─────────────────────────────────────────────────────────────────┘
```

## 8. 错误处理架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        错误处理机制                             │
├─────────────────────────────────────────────────────────────────┤
│  硬件错误:                                                      │
│  ├─ ADC转换超时 → 重新初始化ADC                                │
│  ├─ SPI通信错误 → 复位SPI接口                                  │
│  └─ 看门狗超时 → 系统复位                                      │
├─────────────────────────────────────────────────────────────────┤
│  软件错误:                                                      │
│  ├─ 数据校验失败 → 丢弃数据包                                  │
│  ├─ 滤波参数异常 → 使用默认参数                                │
│  └─ 通信超时 → 重发数据包                                     │
├─────────────────────────────────────────────────────────────────┤
│  应用错误:                                                      │
│  ├─ 超量程检测 → 设置警告标志                                  │
│  ├─ 传感器故障 → 进入安全模式                                  │
│  └─ 通信中断 → 保持最后有效值                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 9. 配置管理架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        配置管理系统                             │
├─────────────────────────────────────────────────────────────────┤
│  运行时配置:                                                    │
│  ├─ 采样频率配置 (25Hz/50Hz/100Hz/1500Hz)                     │
│  ├─ 滤波参数配置 (卡尔曼滤波Q/R值)                             │
│  ├─ 通信参数配置 (波特率/数据格式/从站地址)                     │
│  └─ 系统参数配置 (稳定范围/时间参数)                           │
├─────────────────────────────────────────────────────────────────┤
│  编译时配置:                                                    │
│  ├─ 调试模式开关 (printf_debug/fire_debug)                     │
│  ├─ 功能模块开关 (CHECK_SUM_EN/USE_TIMEOUT_CHECK)             │
│  └─ 硬件配置开关 (USE_INTERNAL_Vref)                          │
└─────────────────────────────────────────────────────────────────┘
```

## 10. 性能指标架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        系统性能指标                             │
├─────────────────────────────────────────────────────────────────┤
│  实时性能:                                                      │
│  ├─ 数据采集频率: 1500Hz                                       │
│  ├─ 滤波处理延迟: <1ms                                         │
│  ├─ 通信响应时间: <10ms                                        │
│  └─ 系统响应时间: <100ms                                       │
├─────────────────────────────────────────────────────────────────┤
│  精度指标:                                                      │
│  ├─ ADC分辨率: 24位                                            │
│  ├─ 测量精度: ±0.01%                                           │
│  ├─ 温度漂移: <10ppm/°C                                        │
│  └─ 长期稳定性: <0.1%/年                                       │
├─────────────────────────────────────────────────────────────────┤
│  可靠性指标:                                                    │
│  ├─ 平均无故障时间: >8760小时                                  │
│  ├─ 数据完整性: 99.99%                                         │
│  ├─ 通信成功率: >99.9%                                         │
│  └─ 系统可用性: >99.9%                                         │
└─────────────────────────────────────────────────────────────────┘
```

这个系统架构图展示了整个STM32F407重量测量系统的完整架构，从硬件抽象层到应用层，从数据流到任务调度，从错误处理到性能指标，为理解和维护系统提供了全面的技术视图。
